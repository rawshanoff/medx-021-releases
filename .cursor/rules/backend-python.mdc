---
description: Backend (FastAPI): auth/roles, ошибки, БД, лицензирование
globs: backend/**/*.py
alwaysApply: false
---

# Backend (FastAPI) правила

- **Auth обязательна**: все бизнес-роуты должны иметь `Depends(require_roles(...))` или эквивалент; исключения: `/health`, `/api/auth/login`.
- **Роли**: используем `UserRole` как единственный источник прав; не делаем “админ всегда true”.
- **JWT**: используем один источник секрета/алгоритма из `backend/core/config.py` (`settings.*`), без дублей.
- **Alembic**: схему БД меняем только миграциями; в рантайме не вызываем `create_all()`.
- **Транзакции**: для сложных операций — атомарность, `rollback` при ошибках.
- **Ошибки**: возвращаем корректные `HTTPException`, не раскрываем внутренние детали; пишем лог причины.
- **Очередь/касса**: любые операции с деньгами и сменами пишем в аудит (кто/что/когда).
