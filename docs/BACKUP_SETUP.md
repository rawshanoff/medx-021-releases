# Настройка ежедневного бэкапа БД

## Windows Task Scheduler

Для автоматического ежедневного бэкапа базы данных PostgreSQL используйте Windows Task Scheduler.

### Шаг 1: Создание задачи

1. Откройте **Планировщик заданий** (Task Scheduler)
2. Нажмите **Создать задачу** (Create Task)
3. Вкладка **Общие** (General):
   - Имя: `MedX Daily Backup`
   - Описание: `Ежедневный бэкап базы данных MedX`
   - Выполнять от имени: выберите пользователя с правами доступа к БД
   - Установите флажок **Выполнять с наивысшими правами** (Run with highest privileges)

### Шаг 2: Триггер

1. Вкладка **Триггеры** (Triggers)
2. Нажмите **Создать** (New)
3. Настройки:
   - Начать задачу: **По расписанию** (On a schedule)
   - Параметры: **Ежедневно** (Daily)
   - Начало: выберите время (например, 02:00 ночи)
   - Повторять задачу каждые: **1 день**
   - Включено: ✓

### Шаг 3: Действие

1. Вкладка **Действия** (Actions)
2. Нажмите **Создать** (New)
3. Настройки:
   - Действие: **Запустить программу** (Start a program)
   - Программа или сценарий: `cmd.exe`
   - Добавить аргументы: `/c "cd /d G:\Projects\021 && scripts\backup_postgres.bat"`
     - Замените `G:\Projects\021` на путь к вашему проекту

### Шаг 4: Условия (опционально)

1. Вкладка **Условия** (Conditions)
2. Снимите флажок **Запускать задачу только при питании от электросети** (Start the task only if the computer is on AC power)
3. Установите флажок **Пробуждать компьютер для выполнения задачи** (Wake the computer to run this task) - опционально

### Шаг 5: Параметры

1. Вкладка **Параметры** (Settings)
2. Установите флажок **Выполнять задачу как можно скорее после пропуска запланированного запуска** (Run task as soon as possible after a scheduled start is missed)
3. Если задача не завершается: **Остановить задачу, выполняющуюся дольше**: 1 час

## Переменные окружения

Убедитесь, что переменная окружения `DATABASE_URL` установлена в системе или в скрипте:

```batch
set DATABASE_URL=postgresql://postgres:PASSWORD@127.0.0.1/medx_db
```

## Проверка

1. Запустите задачу вручную из Планировщика заданий
2. Проверьте папку `backups/YYYY-MM-DD/` на наличие файлов бэкапа
3. Убедитесь, что файлы имеют размер больше 1000 байт

## Ротация бэкапов

Скрипт `backup_postgres.bat` автоматически удаляет бэкапы старше 30 дней.

## Альтернативный вариант: PowerShell скрипт

Можно также создать PowerShell скрипт для более гибкого управления:

```powershell
# backup_scheduled.ps1
$env:DATABASE_URL = "postgresql://postgres:PASSWORD@127.0.0.1/medx_db"
& "G:\Projects\021\scripts\backup_postgres.bat"
```

И использовать его в Task Scheduler вместо cmd.exe.
